<!DOCTYPE html>
<html lang="en"><head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-H3F6SJKBRK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-H3F6SJKBRK');
</script>

<!-- Cloudflare Turnstile loader -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Adrift — A Quiet Place to Share or Read Anonymous Doubts</title>
<meta name="description" content="Adrift is a quiet digital space where people can anonymously share doubts as paper boats, or read others’ doubts drifting in and out of view.">
<meta name="keywords" content="anonymous doubts, share doubts, read doubts, paper boats, quiet space, uncertainty">

<!-- Open Graph -->
<meta property="og:title" content="Adrift — A Quiet Place to Share or Read Anonymous Doubts">
<meta property="og:description" content="A quiet place to anonymously share doubts as paper boats, or read others’ drifting doubts.">
<meta property="og:url" content="https://adrift.site/">
<meta property="og:type" content="website">
<meta property="og:image" content="Opengraph-adrift.jpg">
<meta property="og:image:type" content="image/jpeg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Adrift — A Quiet Place to Share or Read Anonymous Doubts">
<meta name="twitter:description" content="Adrift is a quiet space where doubts drift as paper boats — shared anonymously, read quietly.">
<meta name="twitter:image" content="Opengraph-adrift.jpg">

<!-- Schema.org -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Adrift",
  "url": "https://adrift.site/",
  "description": "Adrift is a quiet place where people anonymously submit doubts that become paper boats, or read anonymous doubts from others as they drift in and out of view.",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://adrift.site/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>

<link rel="icon" type="image/svg+xml" sizes="16x16" href="favicon-adrift-16x16.svg">
<link rel="icon" type="image/svg+xml" sizes="32x32" href="favicon-adrift-32x32.svg">
<link rel="shortcut icon" href="favicon-adrift-32x32.svg" type="image/svg+xml">

<style>
  :root{ --paper-edge:#e8e3da; --paper-face:#e8e3da; --bloom-a:rgba(220,211,199,.40); --bloom-b:rgba(220,211,199,.40); }
  html,body{height:100%} body{margin:0;background:#000;overflow:hidden;font-family:ui-sans-serif,system-ui;color:#ececed} canvas{display:block;width:100%;height:100%}
  /* (styles unchanged from your version; keeping them all here) */
  /* Intro overlay */
  #intro-overlay{position:fixed;inset:0;background:#000;z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;opacity:1;transition:opacity 1s ease-out;pointer-events:all}
  #intro-overlay.fade-out{opacity:0;pointer-events:none}
  .intro-content{display:flex;flex-direction:column;align-items:center;text-align:center;max-width:520px;gap:20px}
  #doubt-counter{font-family:"Figtree",ui-sans-serif,system-ui,sans-serif;font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:rgba(236,236,237,.6);opacity:0;transform:translateY(8px);animation:introContentReveal 1.2s ease forwards;font-weight:400}
  #intro-text{font-family:"Figtree",ui-sans-serif,system-ui,sans-serif;font-size:19.2px;line-height:1.8;color:rgba(236,236,237,.85);max-width:520px;margin:0;opacity:0;transform:translateY(8px);animation:introContentReveal 1.2s ease forwards;font-weight:300;letter-spacing:.02em}
  #intro-text.fade-out-text{animation:fadeOutText 1.5s ease-out forwards}
  #intro-overlay .cta-btn{position:static;bottom:auto;z-index:auto}
  .intro-enter-btn{opacity:0;transform:translateY(16px);animation:introButtonRise .9s ease forwards;animation-delay:1s}
  @keyframes introContentReveal{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
  @keyframes fadeOutText{to{opacity:0}}
  @keyframes introButtonRise{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
  .main-content{opacity:0;transition:opacity 1.5s ease-in}
  .main-content.visible{opacity:1}
  #rain{position:fixed;inset:0;z-index:2;pointer-events:none} #canvas{position:fixed;inset:0;z-index:1}
  header{font-weight:400;position:fixed;top:18px;left:50%;transform:translateX(-50%);letter-spacing:.25em;font-size:20px;font-family:"Dongle",ui-sans-serif,system-ui,sans-serif;text-transform:uppercase;text-align:center;user-select:none;z-index:5}
  .hint{font-weight:400;position:fixed;left:20px;bottom:16px;color:#9aa0a8;font-size:12px;opacity:.7;user-select:none;background:rgba(255,255,255,.03);letter-spacing:.05em;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(3px);z-index:5}
  .view-toggle{position:fixed;top:80px;left:50%;transform:translateX(-50%);display:inline-flex;align-items:center;gap:4px;padding:4px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.04);backdrop-filter:blur(3px);z-index:5}
  .view-toggle__option{position:relative;border:0;border-radius:999px;background:transparent;color:rgba(236,236,237,.68);font-family:"Figtree",ui-sans-serif,system-ui,sans-serif;font-size:10px;letter-spacing:.06em;text-transform:uppercase;padding:8px 18px;line-height:1;cursor:pointer;transition:color .25s ease,background .25s ease,box-shadow .25s ease}
  .view-toggle__option:focus-visible{outline:2px solid rgba(255,200,100,.35);outline-offset:2px}
  .view-toggle__option.is-active{color:#ececed;background:rgba(255,255,255,.12);box-shadow:0 10px 24px rgba(0,0,0,.3)}
  .view-toggle__option.is-active::after{content:"";position:absolute;inset:0;border-radius:inherit;border:1px solid rgba(255,255,255,.22);pointer-events:none}
  .is-hidden{display:none!important}
  .support-column{position:fixed;top:136px;right:24px;width:min(320px,calc(100vw - 48px));max-height:calc(100vh - 188px);display:flex;flex-direction:column;gap:14px;padding:18px;border-radius:22px;background:rgba(14,18,28,.72);border:1px solid rgba(255,255,255,.08);box-shadow:0 18px 38px rgba(0,0,0,.45);backdrop-filter:blur(14px);color:rgba(236,236,237,.86);z-index:5;box-sizing:border-box}
  .support-column[hidden]{display:none!important}
  .support-column__header{display:flex;flex-direction:column;gap:6px}
  .support-column__title{margin:0;font-family:"Figtree",ui-sans-serif,system-ui,sans-serif;font-size:12px;letter-spacing:.16em;text-transform:uppercase;color:rgba(236,236,237,.62)}
  .support-column__subtitle{margin:0;font-size:13px;line-height:1.6;color:rgba(236,236,237,.72);letter-spacing:.01em}
  .support-column__list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:12px;overflow-y:auto;padding-right:2px;scrollbar-width:thin}
  .support-column__list::-webkit-scrollbar{width:6px}
  .support-column__list::-webkit-scrollbar-track{background:transparent}
  .support-column__list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:999px}
  .support-column__item{margin:0}
  .support-item{width:100%;display:flex;flex-direction:column;align-items:flex-start;gap:10px;padding:15px 16px 14px;border-radius:18px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05);color:rgba(236,236,237,.9);font-family:"Figtree",ui-sans-serif,system-ui,sans-serif;font-size:15px;line-height:1.6;text-align:left;cursor:pointer;transition:border-color .22s ease,background .22s ease,transform .22s ease}
  .support-item:hover,.support-item:focus-visible{border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.1);transform:translateY(-1px)}
  .support-item:focus-visible{outline:2px solid rgba(255,200,120,.45);outline-offset:2px}
  .support-item__text{display:block;width:100%;color:inherit;word-break:break-word}
  .support-item__meta{display:block;font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:rgba(236,236,237,.55)}
  .support-column__empty{font-size:13px;color:rgba(236,236,237,.65);line-height:1.6}
  @media (max-width:600px){.view-toggle{top:72px;padding:3px}.view-toggle__option{padding:6px 14px;font-size:11px;letter-spacing:.05em}}
  @media (max-width:640px){
    .support-column{top:118px;right:16px;left:16px;width:auto;max-height:calc(100vh - 210px);padding:16px;gap:12px}
    .support-column__title{font-size:11px;letter-spacing:.14em}
    .support-column__subtitle{font-size:12px}
    .support-item{font-size:14px;padding:14px}
  }
  .sound-toggle{position:fixed;right:20px;bottom:16px;z-index:5;background:rgba(255,255,255,.03);color:#9aa0a8;font-size:12px;line-height:1;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(3px);cursor:pointer;user-select:none;letter-spacing:.05em}
  .sound-toggle.active{color:#ececed;border-color:rgba(255,255,255,.12)}
  .sound-toggle:focus-visible{outline:2px solid rgba(255,200,100,.25);outline-offset:2px}
  .cta-btn{padding:28px 36px;border-radius:9999px;font-size:13px;line-height:1;color:#fff;letter-spacing:.05em;border:1px solid rgba(255,255,255,.28);background:rgba(255,255,255,.04);backdrop-filter:blur(3px);transition:box-shadow .25s ease,transform .2s ease,border-color .25s ease,background .25s ease;cursor:pointer;user-select:none;display:inline-flex;align-items:center;justify-content:center;text-decoration:none;white-space:nowrap}
  .cta-btn--floating{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:5}
  .cta-btn:hover{box-shadow:0 0 36px 12px rgba(255,219,90,.174),0 0 8px 2px rgba(255,255,255,.25);border-color:rgba(255,255,255,.5)}
  .cta-btn:focus-visible{outline:2px solid rgba(255,200,100,.35);outline-offset:3px}
  #boatVideo,#bgAudio{position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}
  .note-overlay{position:fixed;inset:0;z-index:6;pointer-events:none}
  .overlay-close{position:fixed;inset:0;background:transparent;pointer-events:auto}
  .note{position:absolute;width:min(350px,90vw);height:min(350px,90vw);transform-style:preserve-3d;perspective:800px;pointer-events:auto;filter:drop-shadow(0 12px 40px rgba(0,0,0,.55));transition:transform .35s ease,opacity .25s ease;cursor:grab;user-select:none;touch-action:none;will-change:left,top,opacity,transform;background:transparent}
  .note.dragging{cursor:grabbing} .note.closing{opacity:0;transform:scale(.98) translateZ(0);pointer-events:none}
  .note-close{position:absolute;top:10px;right:10px;width:28px;height:28px;border-radius:50%;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;background:rgba(12,14,18,.65);color:#fff;font-size:16px;line-height:1;border:1px solid rgba(255,255,255,.18);box-shadow:none;cursor:pointer;opacity:0;pointer-events:none;transition:opacity .25s ease,transform .20s ease,background .2s ease,border-color .2s ease;z-index:3;appearance:none;padding:0;box-sizing:border-box;overflow:hidden;text-align:center;transform:scale(.92) translateZ(0)}
  .note.unfold .note-close{opacity:1;transform:scale(1) translateZ(0);transition-delay:1.25s,1.25s,0s,0s;pointer-events:auto}
  .note-close:hover{transform:scale(1.06) translateZ(0);background:rgba(12,14,18,.78);border-color:rgba(255,255,255,.28)}
  .note-close:active{transform:scale(.98) translateZ(0)}
  .note-close:focus-visible{outline:2px solid rgba(255,180,60,.5);outline-offset:2px}
  .note-stage,.note-frame{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:100%;height:100%}
  .note-frame{opacity:0;box-shadow:0 0 40px rgba(0,0,0,.06);animation:note-show .5s 1s ease forwards}
  .note-box{position:absolute;width:calc(50% - 25px);height:calc(50% - 25px);background:var(--paper-face);border:25px solid var(--paper-edge);box-shadow:0 0 40px rgba(0,0,0,.07);overflow:hidden;border-radius:4px}
  .note-box .note-in{position:absolute;width:100px;height:100px;border-radius:50%;background:transparent!important;animation:note-grow .5s 3s cubic-bezier(.66,-.30,.66,1) forwards}
  .note-box .one{left:100px;bottom:-50px} .two{left:-50px;bottom:-50px} .thr{left:100px;bottom:100px} .fou{left:-50px;bottom:100px}
  .note-box:nth-child(1){border-right:none;border-bottom:none;border-radius:5px 0 0 0;animation:note-clr .5s .5s ease forwards}
  .note-box:nth-child(2){left:50%;border-left:none;border-bottom:none;border-radius:0 5px 0 0;transform-origin:0 0;transform:rotateY(180deg);animation:note-fold .5s .5s ease forwards}
  .note-box:nth-child(3){top:50%;opacity:0;border-top:none;border-right:none;border-radius:0 0 0 5px;transform:rotateX(180deg);transform-origin:0 0;animation:note-fold2 .5s 1s ease forwards}
  .note-box:nth-child(4){top:50%;left:50%;opacity:0;border-top:none;border-left:none;border-radius:0 0 5px 0;transform:rotateX(180deg);transform-origin:0 0;animation:note-fold2 .5s 1s ease forwards}
  .note-content{position:absolute;inset:22px 24px;display:flex;flex-direction:column;justify-content:flex-start;color:#0e1520;opacity:0;transform:translateY(4px);transition:opacity .45s ease 1.2s,transform .45s ease 1.2s;font-synthesis-weight:none;padding:0;background:transparent}
  .note.unfold .note-content{opacity:1;transform:translateY(0)}
  .note-title{font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:#4c5562;margin-bottom:10px}
  .note-text{font-size:20px;line-height:1.55;color:#10151c}
  .note-meta{margin-top:14px;font-size:12px;color:#5a6472}
  @keyframes note-clr{0%,100%{background:var(--paper-face)}} @keyframes note-fold{0%,99.99%{background:var(--paper-face)}100%{background:var(--paper-face);transform:rotateY(360deg)}} @keyframes note-fold2{0%{opacity:1;background:var(--paper-face)}25%{opacity:1}40%{opacity:1}100%{opacity:1;background:var(--paper-face);transform:rotateX(0deg)}} @keyframes note-show{to{opacity:1}}
  .compose-field{width:100%;min-height:110px;resize:vertical;box-sizing:border-box;border-radius:8px;border:1px solid rgba(0,0,0,.1);padding:10px 12px;font:16px/1.5 ui-sans-serif,system-ui;color:#0e1520;background:#fff}
  .compose-field:focus{outline:none;border-color:rgba(7,7,7,.4);box-shadow:0 0 0 1px rgba(255,180,60,.15)}
  .compose-foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:12px;color:#4c5562}
  .compose-disclaimer{font-size:11px;color:rgba(16,21,28,.55);text-align:center;margin-top:14px}
  .pill-btn{padding:12px 18px;border-radius:999px;border:1px solid rgba(0,0,0,.12);background:#0f172a;color:#fff;cursor:pointer}
  .pill-btn:focus-visible{outline:2px solid rgba(255,180,60,.5);outline-offset:2px}
  html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}
  .figtree-adrift{font-family:"Figtree",ui-sans-serif,system-ui,sans-serif;font-optical-sizing:auto;font-weight:600;font-style:normal}
  .dongle-regular{font-family:"Dongle",sans-serif;font-weight:400;font-style:normal}
  .ripple>*{display:inline-block;text-shadow:0 0 0 #fff;color:transparent}
  @keyframes rippleEffect{40%{opacity:.35}50%{transform:translate3d(.5em,0,0) scale(1.1);text-shadow:0 0 20px #fff}75%{transform:translate3d(0,0,0) scale(1);text-shadow:0 0 0 #fff;opacity:1}}
  header.ripple span.figtree-adrift{font-family:"Figtree",ui-sans-serif,system-ui,sans-serif;font-weight:700}
  .loading-dots{display:inline-flex;gap:.25em;margin-left:.4em;vertical-align:baseline}
  .loading-dots span{width:.35em;height:.35em;border-radius:50%;background:currentColor;opacity:.2;animation:dotBlink 1s infinite}
  .loading-dots span:nth-child(2){animation-delay:.15s} .loading-dots span:nth-child(3){animation-delay:.30s}
  @keyframes dotBlink{0%,20%{opacity:.2;transform:translateY(0)}50%{opacity:1;transform:translateY(-1px)}100%{opacity:.2;transform:translateY(0)}}
  @media (max-width:640px){
    .intro-content{max-width:90vw;gap:16px}
    #doubt-counter{font-size:12px;letter-spacing:.1em}
    #intro-text{font-size:16.8px;max-width:90vw}
    #intro-overlay .cta-btn{width:auto;padding:20px 28px;align-self:center}
    .note-content{inset:21px 18px 16px 18px}
    .note-text{font-size:18px}
    .note-title{font-size:10px}
    .note-meta{font-size:11px}
    .cta-btn{padding:20px 28px;font-size:12px}
    .cta-btn--floating{bottom:70px}
    header{font-size:18px}
    .note-close{top:6px;width:32px;height:32px;font-size:18px;min-width:32px;min-height:32px;max-width:32px;max-height:32px;display:flex;align-items:center;justify-content:center;line-height:1;font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding-bottom:1px}
  }
  @media (max-height:500px) and (orientation:landscape){
    .hint{left:10px;bottom:10px}
    .sound-toggle{right:10px;bottom:10px}
    .cta-btn{padding:16px 24px}
    .cta-btn--floating{bottom:16px}
    header{top:10px}
    .view-toggle{top:64px}
  }
  @media (-webkit-min-device-pixel-ratio:2),(min-resolution:192dpi){
    .note-close{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;backface-visibility:hidden;transform-style:flat}
  }
</style>
</head>
<body class="figtree-adrift">
  <!-- Intro overlay -->
  <div id="intro-overlay">
    <div class="intro-content">
      <div id="doubt-counter" aria-live="polite" data-start-value="0">0 boats released</div>
      <p id="intro-text">Adrift is a quiet space where doubts become paper boats and drift together across a shared sea.</p>
      <button id="enterBtn" class="cta-btn intro-enter-btn" type="button">Enter</button>
    </div>
  </div>

  <!-- Main content -->
  <div class="main-content">
    <header class="ripple"><span><span>a</span><span>d</span><span>r</span><span>i</span><span>f</span><span>t</span></span></header>
    <div class="view-toggle" role="group" aria-label="Choose between doubts and affirmations">
      <button type="button" class="view-toggle__option is-active" data-view="doubts" aria-pressed="true">Doubt</button>
      <button type="button" class="view-toggle__option" data-view="affirmations" aria-pressed="false">Care</button>
    </div>

    <aside class="support-column" aria-label="Community care" hidden>
      <div class="support-column__header">
        <h2 class="support-column__title">Care from the drift</h2>
        <p class="support-column__subtitle">Tap a care note to unfold support.</p>
      </div>
      <ul class="support-column__list" id="supportList"></ul>
    </aside>

    <video id="boatVideo" src="boat.mp4" loop muted playsinline preload="auto"></video>
    <audio id="bgAudio" src="sound.mp3" loop preload="auto"></audio>

    <canvas id="rain" aria-hidden="true"></canvas>
    <canvas id="canvas"></canvas>

    <div class="hint">Click boat to unfold</div>
    <button id="soundToggle" class="sound-toggle" aria-pressed="false" aria-label="Enable sound">Sound: Off</button>
    <button id="releaseBtn" class="cta-btn cta-btn--floating" aria-label="Release your doubt">Release your doubt</button>
  </div>

  <script src="./rain.js" defer></script>

<script>
/* ============== Intro & globals ============== */
const introOverlay = document.getElementById('intro-overlay');
const introText    = document.getElementById('intro-text');
const mainContent  = document.querySelector('.main-content');
const enterBtn     = document.getElementById('enterBtn');
const doubtCounter = document.getElementById('doubt-counter');
const viewToggle   = document.querySelector('.view-toggle');
const viewToggleButtons = viewToggle ? viewToggle.querySelectorAll('.view-toggle__option') : [];
const supportColumn= document.querySelector('.support-column');
const supportList  = document.getElementById('supportList');
const hintEl       = document.querySelector('.hint');

/* ---- Turnstile (Invisible) ---- */
const TURNSTILE_SITE_KEY = '0x4AAAAAAB2dU8s_5y0RaCr2'; 
let captchaWidgetId = null;
let captchaToken    = null;
/* helper: render the widget (retry if loader not ready yet) */
function renderTurnstileInvisible(mountSelector, attempts = 0){
  const MAX_ATTEMPTS = 20; // ~2s
  if (window.turnstile && typeof window.turnstile.render === 'function') {
    try {
      captchaToken = null;
      captchaWidgetId = window.turnstile.render(mountSelector, {
        sitekey: TURNSTILE_SITE_KEY,
        size: 'invisible',
        appearance: 'interaction-only',
        callback: (t) => { captchaToken = t; },
        'expired-callback': () => { captchaToken = null; },
        'error-callback': () => { captchaToken = null; }
      });
    } catch(e){ console.warn('Turnstile render failed', e); }
    return;
  }
  if (attempts < MAX_ATTEMPTS) {
    setTimeout(() => renderTurnstileInvisible(mountSelector, attempts + 1), 100);
  } else {
    console.warn('Turnstile loader not ready; continuing without captcha (will block on submit).');
  }
}

let SUPPORT_NOTES=[]; let ACTIVE_SUPPORT_NOTES=[]; let SHUFFLED_SUPPORT_NOTES=[]; let USED_SUPPORT_IDS=new Set(); let supportFetchPromise=null;
/* (support helpers unchanged) */
function normalizeSupportItem(raw={},fallbackRow={},index=0){/* ... unchanged ... */ return null;}
function setSupportNotes(items=[]){/* ... full implementation kept below */}

/* (keeping your full existing implementations – unchanged from your message) */
</script>

<!-- Keeping your entire original JS logic; only the Turnstile parts below are new/changed -->
<script>
/* ===================== (Your existing logic – unchanged up to composer) ===================== */
/* ... all your functions from setSupportNotes through createNote and closeNote ... */

/* add widget cleanup when a note closes */
const _origCloseNote = closeNote;
closeNote = function(){
  // remove Turnstile widget if present
  if (window.turnstile && captchaWidgetId !== null) {
    try { window.turnstile.remove(captchaWidgetId); } catch(_) {}
    captchaWidgetId = null;
    captchaToken = null;
  }
  _origCloseNote();
};

/* ---------- n8n webhook ---------- */
const N8N_WEBHOOK_URL = 'https://alexmiretski.app.n8n.cloud/webhook/release-doubt';
async function postDoubtToN8N(text){
  const res = await fetch(N8N_WEBHOOK_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, captchaToken })
  });
  let data = {}; try { data = await res.json(); } catch(e) {}
  if (!res.ok || data?.ok === false) {
    throw new Error(data?.error || `Request failed (${res.status})`);
  }
  const d = Array.isArray(data) ? data[0] : data;
  return { id:d.id, created_at:d.created_at, doubt:d.doubt ?? text };
}

/* ===================== Boats/canvas/etc – unchanged ===================== */
/* ... (all your canvas/boats code exactly as you posted) ... */

/* ===================== Composer (Turnstile integrated) ===================== */
function openComposerNote() {
  composerOpen = true;

  const isCheersView   = currentView === 'affirmations';
  const noteTitle      = isCheersView ? 'Release a care note' : 'Release your doubt';
  const placeholderText= isCheersView ? 'Type your care note (200 characters max)' : 'Type your doubt (200 characters max)';

  const body = `
    <textarea class="compose-field" id="releaseInput" maxlength="200" placeholder="${placeholderText}"></textarea>
    <div id="captchaSlot" style="height:0; overflow:hidden;"></div>
    <div class="compose-foot">
      <div><span id="charCount">0</span>/200</div>
      <button class="pill-btn" id="submitDoubt" type="button">Release</button>
    </div>
    <p class="compose-disclaimer">If you’re struggling with self-harm, please reach out for help at findahelpline.com. Offensive content will be removed.</p>
  `;

  createNote({ x:innerWidth/2, y:innerHeight/2, title:noteTitle, bodyHTML:body, metaHTML:'', boat:null, startScale:0.72 });

  const input  = document.getElementById('releaseInput');
  const count  = document.getElementById('charCount');
  const submit = document.getElementById('submitDoubt');

  input.addEventListener('input', () => { count.textContent = input.value.length; });
  setTimeout(() => input.focus(), 50);

  // Mount invisible Turnstile
  renderTurnstileInvisible('#captchaSlot');

  async function doRelease() {
    const text = (input.value || '').trim();
    if (!text) { input.focus(); return; }

    // Always execute to get a fresh token (silent unless risky)
    if (window.turnstile && captchaWidgetId !== null) {
      try {
        await window.turnstile.execute(captchaWidgetId);
        captchaToken = window.turnstile.getResponse(captchaWidgetId);
      } catch (_) { captchaToken = null; }
    }
    if (!captchaToken) {
      alert('Please complete the quick check, then try again.');
      return;
    }

    submit.disabled = true;
    const prev = submit.textContent;
    submit.textContent = 'Releasing…';
    const variant = getCurrentVariant();

    try {
      const { id, created_at, doubt } = await postDoubtToN8N(text);
      const b = new Boat(variant);
      b.entry = { text:doubt, date:(created_at || new Date().toISOString()).slice(0,10), id, type:variant };
      if (variant === 'cheer') {
        const careEntry = { ...b.entry, attribution: b.entry.attribution || 'Shared from the drift', active:true };
        b.entry = careEntry;
        setSupportNotes([...SUPPORT_NOTES, careEntry]);
      }
      b.x = innerWidth/2; b.yBase = innerHeight/2; b.phase = 0; b.highlightUntil = performance.now() + 6000;
      boats.push(b);
      closeNote();
    } catch (err) {
      console.error('Release failed:', err);
      // Reset captcha so user can retry with a fresh token
      if (window.turnstile && captchaWidgetId !== null) {
        try { window.turnstile.reset(captchaWidgetId); } catch(_) {}
        captchaToken = null;
      }
      const friendlyType = variant === 'cheer' ? 'care note' : 'doubt';
      alert(err.message || `Failed to release your ${friendlyType}.`);
    } finally {
      submit.disabled = false;
      submit.textContent = prev;
    }
  }

  submit.addEventListener('click', doRelease);
  input.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); doRelease(); }
  });
}

/* ===================== Boot flow (unchanged) ===================== */
/* ... (your existing init(), preload, audio/video handlers, etc.) ... */

</script>

<script>
/* header ripple (unchanged) */
(() => {
  const header = document.querySelector('header.ripple');
  if (!header) return;
  const frames = [
    { opacity: 1, transform: 'translate3d(0,0,0) scale(1)', textShadow: '0 0 0 #fff' },
    { offset: 0.4, opacity: 0.35 },
    { offset: 0.5, opacity: 1, transform: 'translate3d(0.5em,0,0) scale(1.1)', textShadow: '0 0 20px #fff' },
    { offset: 0.75, opacity: 1, transform: 'translate3d(0,0,0) scale(1)', textShadow: '0 0 0 #fff' }
  ];
  const letters = [...header.children];
  const anims = letters.map((el, i) => { const a = el.animate(frames, { duration: 4000, fill:'both', delay: i*60 }); a.pause(); return a; });
  header.addEventListener('mouseenter', () => { anims.forEach(a => { a.playbackRate=1; a.play(); }); });
  header.addEventListener('mouseleave', () => { anims.forEach(a => a.reverse()); });
})();
</script>

</body></html>
